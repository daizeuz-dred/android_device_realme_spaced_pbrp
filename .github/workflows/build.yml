name: PBRP Build
on:
  workflow_dispatch:
    inputs:
      DEPLOY_TYPE:
        description: 'Deploy Type (TEST/BETA/OFFICIAL)'
        required: true
        default: 'TEST'
      ChangeLogs:
        description: 'Build ChangeLogs'
        required: true
        default: 'Sync Latest Source'

env:
  BUILD_RELEASE_TYPE: ${{ github.event.inputs.DEPLOY_TYPE }}
  CHANGELOG: ${{ github.event.inputs.ChangeLogs }}
  TARGET: "pbrp"

jobs:
  PBRP_CI:
    runs-on: ubuntu-latest
    steps:
       - name: Free Disk Space (Safe Cleanup)
         run: |
           # Delete large pre-installed tools but KEEP apt sources
           sudo rm -rf /usr/share/dotnet
           sudo rm -rf /usr/local/lib/android
           sudo rm -rf /opt/ghc
           sudo rm -rf "/usr/local/share/boost"
           sudo docker image prune -a -f
           sudo apt-get clean
           echo "Disk space after cleanup:"
           df -h /

       - name: Check Environment
         run: |
           echo "Triggering build for branch: ${GITHUB_REF##*/}"
           echo "Running on: ${{ runner.os }}"

       - name: Set Build Environment
         run: |
           # Point to the official PBRP manifest and branch
           echo "MANIFEST=https://github.com/PitchBlackRecoveryProject/manifest_pb" >> $GITHUB_ENV
           echo "MANIFEST_BRANCH=android-12.1" >> $GITHUB_ENV
           echo "BUILD_PATH=$GITHUB_WORKSPACE/pbrp" >> $GITHUB_ENV
           
       - name: Install Dependencies and Repo Tool
         run: |
           sudo apt-get update
           sudo apt-get install -y bc build-essential zip curl libstdc++6 git wget python3 sshpass
           # Install repo
           mkdir -p ~/bin
           curl https://storage.googleapis.com/git-repo-downloads/repo > ~/bin/repo
           chmod a+x ~/bin/repo
           echo "$HOME/bin" >> $GITHUB_PATH
           
       - name: Sync PBRP Source (Shallow)
         run: |
           mkdir -p pbrp
           cd pbrp
           git config --global user.email "bot@pbrp.co"
           git config --global user.name "PBRP Bot"
           
           # Initialize and sync with minimal depth to save space
           ~/bin/repo init -u $MANIFEST -b $MANIFEST_BRANCH --depth=1
           ~/bin/repo sync -c -j$(nproc --all) --force-sync --no-tags --no-clone-bundle
           
           # CRITICAL: Delete the .repo folder after syncing to free up ~15GB for the build
           rm -rf .repo

       - name: Clone Device Tree
         run: |
           # Replace 'realme' and 'spaced' with your actual manufacturer and codename
           cd $BUILD_PATH
           git clone https://github.com/${{ github.repository }} -b main device/realme/spaced

       - name: Build Recovery
         run: |
           cd $BUILD_PATH
           source build/envsetup.sh
           
           # Try to lunch based on your repository name
           # If this fails, manually change 'spaced' to your device codename
           lunch pbrp_${{ github.event.repository.name }}-eng || lunch omni_${{ github.event.repository.name }}-eng
           
           mka recoveryimage

       - name: Release Builds 
         run: |
           cd $BUILD_PATH
           echo "Checking for output files..."
           find out/target/product/ -name "PitchBlack*.zip" -exec ls -lh {} + || echo "No build found."
