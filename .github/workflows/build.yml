name: PBRP Build
on:
  workflow_dispatch:
    inputs:
      DEPLOY_TYPE:
        description: 'Deploy Type (TEST/BETA/OFFICIAL)'
        required: true
        default: 'TEST'
      ChangeLogs:
        description: 'Build ChangeLogs'
        required: true
        default: 'Sync Latest Source'

env:
  BUILD_RELEASE_TYPE: ${{ github.event.inputs.DEPLOY_TYPE }}
  CHANGELOG: ${{ github.event.inputs.ChangeLogs }}
  TARGET: "pbrp"

jobs:
  PBRP_CI:
    runs-on: ubuntu-latest
    steps:
       - name: Check Environment
         run: |
           echo "Triggering build for branch: ${GITHUB_REF##*/}"
           echo "Running on: ${{ runner.os }}"

       - name: Set Build Environment
         run: |
           echo "MANIFEST=https://github.com/PitchBlackRecoveryProject/manifest_pb -b ${GITHUB_REF##*/}" >> $GITHUB_ENV
           # Setting up variables normally handled by the PBRP Compiler
           echo "BUILD_PATH=$GITHUB_WORKSPACE/pbrp" >> $GITHUB_ENV

       - name: Install Dependencies
         run: |
           sudo apt-get update
           sudo apt-get install -y bc build-essential zip curl libstdc++6 git wget python3 sshpass

       - name: Sync PBRP Source
         run: |
           mkdir -p $BUILD_PATH
           cd $BUILD_PATH
           git config --global user.email "bot@pbrp.co"
           git config --global user.name "PBRP Bot"
           # This uses the public manifest instead of the private compiler
           repo init -u $MANIFEST --depth=1
           repo sync -j$(nproc --all) --force-sync --no-tags --no-clone-bundle

       - name: Build Recovery
         run: |
           cd $BUILD_PATH
           . build/envsetup.sh
           # You may need to change 'pbrp' to your specific lunch target
           lunch pbrp_${{ github.event.repository.name }}-eng || lunch omni_${{ github.event.repository.name }}-eng
           mka recoveryimage

       - name: Release Builds 
         run: |
           cd $BUILD_PATH
           # If you have your own deploy script, run it here. 
           # Since we bypassed the PBRP vendor tools, we run a simple upload or list check.
           ls -lh out/target/product/*/PitchBlack*.zip || echo "Build failed or output not found"
